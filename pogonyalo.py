import json
import random
import pytz
from datetime import time
from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, ContextTypes, filters

# ==== НАСТРОЙКИ ====
TOKEN = "8384986879:AAGUBtm3Fg0cNUa-IlroraoWQ1M7eMz2PNM"
BTN_GEN = "Сгенерировать погоняло"

# твой список
NICKNAMES = [
    "Лепман Коричневый Змей", "Лепман Марафон Коричневых Змей", "Лепман Снюсный Барон", "Лепман Король Желтых Дождей",
    "Лепман Линьчиковый Лежун", "Лепман Животик+2кг", "Лепман Балду Пинатель", "Лепман Унитаз — Это Жизнь",
    "Лепман Железный Снюсоносец", "Лепман Титан Подоконника", "Лепман Властелин Люкса", "Лепман Папа Линьчика",
    "Лепман Гроза Окон", "Лепман Шлёп Утренний", "Лепман Книга-Моча", "Лепман Лежит И Красивый",
    "Лепман 110 Коричневый", "Лепман С Продристью", "Лепман Вечный Балабол", "Лепман Круг Самопотерянных",
    "Верховный Бушист",
    "Главный Анус", "Кишка-Пожиратель", "Бушистый Подзалупин", "Анусоносец", "Кишка Линьчиковая",
    "Повелитель Бушизма и Анусов", "Сипарь С Очком", "Гнойный Линьчикарь", "Магистр Заднепрохода",
    "Трипперный Бушонок", "Кишка-Пердуша", "Анусоразрушитель", "Сипун Глубокого Очка", "Кикшевый Громила",
    "Очконосный Архонт", "Анусоед Линьчиков", "Бушизмовод Очковый", "Кишка-Вонючка", "Сипоносец Анусов",
    "Паховый Линьчикарь", "Заднепроходный Пророк", "Кишка Мясная", "Линьчикоанус", "Очковый Шаман",
    "Кишка-Разрушитель", "Анусный Оракул", "Бушист Сраный", "Гнойно-Сипучий", "Кишка-Вертолёт",
    "Очкодав Бушизма", "Сральный Линьчикарь", "Кикшевый Сосальщик", "Анусообниматель", "Линьчикоразрыватель",
    "Сипарь Очковый", "Кишка-Мочалка", "Бушизмовый Говнарь", "Очковый Кикшевод", "Анусоносный Линьчикарь",
    "Кишка Сырная", "Очкосос Легендарный", "Линьчикоочкоед", "Кишка-Свинтус", "Очкодавец Бушистый",
    "Анусовый Гроза", "Кишка Плесневелая", "Сипарь Глубинный", "Очкоразрушитель Линьчиков", "Кишка Кислотная",
    "Бушизмопердун", "Очковый Повелитель", "Кишка-Венеричка", "Линьчикоочковый", "Гнойно-Кикшевый",
    "Анусоноситель", "Кишка-Хрюша", "Очковый Линьчикарь", "Сипарь Анусный", "Кишка-Жмур", "Очкозавр",
    "Анусораздуватель", "Линьчикоанальный", "Кишка-Брызгун", "Очковый Рыцарь", "Гнойный Очкоед",
    "Кишка-Мазохист", "Анусоочиститель", "Очкокидатель", "Кишка-Червивый", "Бушизмосраколиз",
    "Очковый Инквизитор", "Кишка-Перделка", "Анусотряс", "Сипарь Сральный", "Очкосекущий",
    "Кишка-Заднеприводный", "Линьчикосос Анусов", "Очконосец", "Кишка-Вшивка", "Анусобушонок",
    "Очковый Зверь", "Кишка-Срачмейстер", "Гнойно-Анусный", "Очкотрон 3000", "Кишка-Бушист",
    "Анусодушитель", "Очковый Мрак", "Кишка-Пердач", "Анусорез", "Очковый Линьчикоед", "Кишка-Сипарь",
    "Бушизмочкоед", "Очковый Вонючка", "Кишка-Анусонос", "Сипарь Очковый Грозный", "Попочка с сисечками",
    "Анусоразбойник", "Кишка-Очковерт", "Очковый Линьчикоразрушитель",
    "Лепман Мастер Проливных Дождей", "Лепман Линьчиковый Гладиатор", "Лепман Снюс на Вечер",
    "Лепман Хранитель Преворкаута", "Лепман Писатель Битов", "Лепман Писаться Идём", "Лепман Сношающий Рты",
    "Лепман Легенда Жёлтого Потока", "Лепман Я Реально Красивый", "Лепман Властелин Линьчика", "Лепман Мастер 30 Секунд",
    "Лепман Философ Унитаза", "Лепман Проклятый Линьчикер", "Лепман Шаман Желтых Дождей", "Лепман Снюсный Унитазист",
    "Лепман Разгон До 110", "Лепман Человек-Снюс", "Лепман Битмейкер Линьчика", "Лепман Преворкаутный",
    "Лепман Снюсо-Варвар", "Лепман Гроза Книг-Мочи", "Лепман Железный Преворкаут", "Лепман Жёлтый Поток",
    "Лепман Мочевой Магистр", "Лепман Властелин Балды", "Лепман Линьчиковый Мститель", "Лепман Легенда Снюса",
    "Лепман Книга-Снюс", "Лепман Мастер Бутылочного Дождя", "Лепман Король Продристи", "Лепман Снюсо-Рокер",
    "Лепман Мокрый Линьчик", "Лепман Железный Лежун", "Лепман Преворкаутный Шаман", "Лепман Снюсо-Босс",
    "Лепман Книга-Гроза", "Лепман Жёлтый Призыватель", "Лепман Линьчиковый Принц", "Лепман Гроза Люкса",
    "Лепман Марафонщик Линьчика", "Лепман Папа Продристи", "Лепман Легенда Марафона", "Лепман Железный Снюс-Маг",
    "Лепман Король Оконных Дождей", "Лепман Мастер Потоков", "Лепман Балду-Каратель", "Лепман Снюсный Философ",
    "Лепман Преворкаутный Барон", "Лепман Линьчиковый Разрушитель", "Лепман Гроза Сантехники", "Лепман Жёлтый Маг",
    "Лепман Властелин Продристь", "Лепман Марафон Люксов", "Лепман Железный Балабол", "Лепман Снюсный Бродяга",
    "Лепман Преворкаутный Гладиатор", "Лепман Линьчиковый Певец", "Лепман Мастер Жёлтого Потока", "Лепман Книга-Воин",
    "Лепман Снюсо-Легенда", "Лепман Железный Поточник", "Лепман Гроза 110", "Лепман Марафон Мочи",
    "Лепман Властелин Линьчиковых Ночей", "Лепман Мастер Продристь", "Лепман Снюсный Принц", "Лепман Балду-Ломатель",
    "Лепман Железный Книгач", "Лепман Линьчиковый Шутник", "Лепман Преворкаутный Лев", "Лепман Жёлтый Джедай",
    "Лепман Книга-Гладиатор", "Лепман Снюсо-Герой", "Лепман Мастер Люксов", "Лепман Гроза Линьчика",
    "Лепман Железный Дождевик", "Лепман Преворкаутный Сокол", "Лепман Линьчиковый Левиафан", "Лепман Снюсный Рыцарь",
    "Лепман Легенда Книг", "Лепман Железный Мочевик", "Лепман Преворкаутный Чародей", "Лепман Марафонский Жрец",
    "Лепман Балду-Разрушитель", "Лепман Линьчиковый Орёл", "Лепман Жёлтый Фараон", "Лепман Снюсный Гуру",
    "Лепман Книга-Царь", "Лепман Преворкаутный Волк", "Лепман Железный Шаман", "Лепман Гроза Потоков",
    "Лепман Марафон Линьчика", "Лепман Линьчиковый Шаман", "Лепман Снюсо-Мастер", "Лепман Книга-Властелин",
    "Лепман Жёлтый Гладиатор", "Лепман Преворкаутный Легенд", "Лепман Железный Линьчикер", "Лепман Балду-Монарх",
    "Лепман Линьчиковый Властелин", "Лепман Снюсный Лев", "Лепман Марафонный Джин", "Лепман Жёлтый Босс",
    "Лепман Преворкаутный Папа", "Лепман Книга-Балабол", "Лепман Железный Люкс", "Лепман Снюсо-Бог",
    "Лепман Гроза Марафона", "Лепман Линьчиковый Папа", "Лепман Марафонщик Люксов", "Лепман Жёлтый Гроза",
    "Лепман Балду-Легенда", "Лепман Преворкаутный Орёл", "Лепман Книга-Поток", "Лепман Железный Марафонец",
    "Лепман Снюсо-Властелин", "Лепман Линьчиковый Волк", "Лепман Жёлтый Шаман", "Лепман Балду-Магистр",
    "Лепман Преворкаутный Гроза", "Лепман Книга-Дождевик", "Лепман Железный Поток", "Лепман Снюсо-Орёл",
    "Лепман Линьчиковый Барон", "Лепман Марафонский Волк", "Лепман Жёлтый Легенд", "Лепман Балду-Папа",
    "Лепман Преворкаутный Мастер", "Лепман Книга-Орёл", "Лепман Железный Властелин", "Лепман Снюсо-Джедай",
    "Лепман Линьчиковый Джин", "Лепман Марафонский Лев", "Лепман Жёлтый Призрак", "Лепман Балду-Герой",
    "Лепман Преворкаутный Линьчикер", "Лепман Книга-Гроза", "Лепман Железный Лев", "Лепман Снюсо-Фараон",
    "Лепман Линьчиковый Бог", "Лепман Марафонский Линьчик", "Лепман Жёлтый Книгач", "Лепман Балду-Мочевик",
    "Лепман Преворкаутный Поток", "Лепман Книга-Марафонец", "Лепман Сип-мастер", "Лепман Великий Сипун",
    "Лепман Сип-Барон", "Лепман Легенда Сипа", "Лепман Король Сипа", "Лепман Сипун Гладиатор",
    "Лепман Сип-Гроза", "Лепман Сипун Шаман", "Лепман Сипный Волк", "Лепман Марафон Сипа"
]

STATE_FILE = "state.json"


# ==== ВСПОМОГАТЕЛЬНЫЕ ====
def load_state():
    try:
        with open(STATE_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    except FileNotFoundError:
        return {}

def save_state(state):
    with open(STATE_FILE, "w", encoding="utf-8") as f:
        json.dump(state, f, ensure_ascii=False, indent=2)

def nickname_core(n: str) -> str:
    # убираем префикс "Лепман" и тире, если он есть; иначе возвращаем как есть
    s = n
    if s.lower().startswith("лепман"):
        s = s[len("Лепман"):].strip(" —-")
    return s.strip()

def pick_for_history(history: list[str]) -> str:
    pool = [n for n in NICKNAMES if n not in history]
    if not pool:
        history.clear()
        pool = NICKNAMES[:]
    choice = random.choice(pool)
    history.append(choice)
    if len(history) > 7:
        history.pop(0)
    return choice

def pick_name_html(chat_id: int) -> str:
    """Для /lep и кнопки: «Лепман — <i>…</i>» с учётом истории чата"""
    state = load_state()
    entry = state.get(str(chat_id)) or {"history": []}
    nick = pick_for_history(entry["history"])
    state[str(chat_id)] = entry
    save_state(state)
    core = nickname_core(nick)
    return f"<b>Лепман</b> — <i>{core}</i>"

def ensure_chat_entry(chat_id: int):
    state = load_state()
    if str(chat_id) not in state:
        state[str(chat_id)] = {"history": []}
        save_state(state)

# ==== КОМАНДЫ/ХЕНДЛЕРЫ ====
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = ReplyKeyboardMarkup([[BTN_GEN]], resize_keyboard=True)
    await update.effective_message.reply_text("жми кнопку ниже ↓", reply_markup=kb)

async def lep_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    html = pick_name_html(update.effective_chat.id)
    await context.bot.send_message(
        chat_id=update.effective_chat.id,
        text=html,
        parse_mode="HTML"
    )

async def on_button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if (update.effective_message.text or "").strip() == BTN_GEN:
        html = pick_name_html(update.effective_chat.id)
        await update.effective_message.reply_html(html)

async def set_daily(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Включает ежедневную выдачу для *текущего чата* и сохраняет, кого тэгать."""
    chat_id = str(update.effective_chat.id)
    user = update.effective_user
    username = user.username or user.first_name or "друг"

    state = load_state()
    entry = state.get(chat_id) or {"history": []}
    entry["target"] = {"id": user.id, "username": username}
    state[chat_id] = entry
    save_state(state)

    await update.effective_message.reply_text("Буду выдавать тебе погоняло каждый день в 12:00 по МСК")

async def stop_daily(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = str(update.effective_chat.id)
    state = load_state()
    if chat_id in state and ("target" in state[chat_id]):
        # не удаляем историю целиком — только цель рассылки
        del state[chat_id]["target"]
        save_state(state)
        await update.effective_message.reply_text("Ежедневная выдача в этом чате отключена.")
    else:
        await update.effective_message.reply_text("В этом чате ежедневная выдача и так выключена.")

async def daily_job(context: ContextTypes.DEFAULT_TYPE):
    """Ежедневная рассылка: «@username — *погоняло*» в канале/чате, где включили."""
    state = load_state()
    updates = False
    for chat_id, entry in state.items():
        target = entry.get("target")
        if not target:
            continue
        # подобрать ник без повторов последних 7
        nick_full = pick_for_history(entry.setdefault("history", []))
        core = nickname_core(nick_full)
        username = target.get("username") or "друг"

        # отправляем в чат, формат '@username — *погоняло*'
        try:
            await context.bot.send_message(
                chat_id=int(chat_id),
                text=f"@{username} — *{core}*",
                parse_mode="Markdown"
            )
        except Exception as e:
            # если не получилось отправить — просто пропустим
            print(f"daily send failed for {chat_id}: {e}")
        updates = True

    if updates:
        save_state(state)

# ==== MAIN ====
def main():
    app = ApplicationBuilder().token(TOKEN).build()

    # ежедневная задача в 12:00 по МСК
    msk = pytz.timezone("Europe/Moscow")
    app.job_queue.run_daily(daily_job, time(hour=12, minute=0, tzinfo=msk))

    # команды/хендлеры
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("lep", lep_cmd))
    app.add_handler(CommandHandler("setdaily", set_daily))
    app.add_handler(CommandHandler("stopdaily", stop_daily))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, on_button))

    app.run_polling()

if __name__ == "__main__":
    main()

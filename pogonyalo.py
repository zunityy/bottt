import json
import random
import html
import pytz
from datetime import time
from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, ContextTypes, filters

# ==== НАСТРОЙКИ ====
TOKEN = "8384986879:AAGUBtm3Fg0cNUa-IlroraoWQ1M7eMz2PNM"  # <-- вставь токен
BTN_GEN = "Сгенерировать погоняло"

# твой список никнеймов:
NICKNAMES = [
    "Лепман Коричневый Змей", "Лепман Марафон Коричневых Змей", "Лепман Снюсный Барон", "Лепман Король Желтых Дождей",
    "Лепман Линьчиковый Лежун", "Лепман Животик+2кг", "Лепман Балду Пинатель", "Лепман Унитаз — Это Жизнь",
    "Лепман Железный Снюсоносец", "Лепман Титан Подоконника", "Лепман Властелин Люкса", "Лепман Папа Линьчика",
    "Лепман Гроза Окон", "Лепман Шлёп Утренний", "Лепман Книга-Моча", "Лепман Лежит И Красивый",
    "Лепман 110 Коричневый", "Лепман С Продристью", "Лепман Вечный Балабол", "Лепман Круг Самопотерянных",
    "Верховный Бушист",
    "Главный Анус", "Кишка-Пожиратель", "Бушистый Подзалупин", "Анусоносец", "Кишка Линьчиковая",
    "Повелитель Бушизма и Анусов", "Сипарь С Очком", "Гнойный Линьчикарь", "Магистр Заднепрохода",
    "Трипперный Бушонок", "Кишка-Пердуша", "Анусоразрушитель", "Сипун Глубокого Очка", "Кикшевый Громила",
    "Очконосный Архонт", "Анусоед Линьчиков", "Бушизмовод Очковый", "Кишка-Вонючка", "Сипоносец Анусов",
    "Паховый Линьчикарь", "Заднепроходный Пророк", "Кишка Мясная", "Линьчикоанус", "Очковый Шаман",
    "Кишка-Разрушитель", "Анусный Оракул", "Бушист Сраный", "Гнойно-Сипучий", "Кишка-Вертолёт",
    "Очкодав Бушизма", "Сральный Линьчикарь", "Кикшевый Сосальщик", "Анусообниматель", "Линьчикоразрыватель",
    "Сипарь Очковый", "Кишка-Мочалка", "Бушизмовый Говнарь", "Очковый Кикшевод", "Анусоносный Линьчикарь",
    "Кишка Сырная", "Очкосос Легендарный", "Линьчикоочкоед", "Кишка-Свинтус", "Очкодавец Бушистый",
    "Анусовый Гроза", "Кишка Плесневелая", "Сипарь Глубинный", "Очкоразрушитель Линьчиков", "Кишка Кислотная",
    "Бушизмопердун", "Очковый Повелитель", "Кишка-Венеричка", "Линьчикоочковый", "Гнойно-Кикшевый",
    "Анусоноситель", "Кишка-Хрюша", "Очковый Линьчикарь", "Сипарь Анусный", "Кишка-Жмур", "Очкозавр",
    "Анусораздуватель", "Линьчикоанальный", "Кишка-Брызгун", "Очковый Рыцарь", "Гнойный Очкоед",
    "Кишка-Мазохист", "Анусоочиститель", "Очкокидатель", "Кишка-Червивый", "Бушизмосраколиз",
    "Очковый Инквизитор", "Кишка-Перделка", "Анусотряс", "Сипарь Сральный", "Очкосекущий",
    "Кишка-Заднеприводный", "Линьчикосос Анусов", "Очконосец", "Кишка-Вшивка", "Анусобушонок",
    "Очковый Зверь", "Кишка-Срачмейстер", "Гнойно-Анусный", "Очкотрон 3000", "Кишка-Бушист",
    "Анусодушитель", "Очковый Мрак", "Кишка-Пердач", "Анусорез", "Очковый Линьчикоед", "Кишка-Сипарь",
    "Бушизмочкоед", "Очковый Вонючка", "Кишка-Анусонос", "Сипарь Очковый Грозный", "Попочка с сисечками",
    "Анусоразбойник", "Кишка-Очковерт", "Очковый Линьчикоразрушитель",
    "Лепман Мастер Проливных Дождей", "Лепман Линьчиковый Гладиатор", "Лепман Снюс на Вечер",
    "Лепман Хранитель Преворкаута", "Лепман Писатель Битов", "Лепман Писаться Идём", "Лепман Сношающий Рты",
    "Лепман Легенда Жёлтого Потока", "Лепман Я Реально Красивый", "Лепман Властелин Линьчика", "Лепман Мастер 30 Секунд",
    "Лепман Философ Унитаза", "Лепман Проклятый Линьчикер", "Лепман Шаман Желтых Дождей", "Лепман Снюсный Унитазист",
    "Лепман Разгон До 110", "Лепман Человек-Снюс", "Лепман Битмейкер Линьчика", "Лепман Преворкаутный",
    "Лепман Снюсо-Варвар", "Лепман Гроза Книг-Мочи", "Лепман Железный Преворкаут", "Лепман Жёлтый Поток",
    "Лепман Мочевой Магистр", "Лепман Властелин Балды", "Лепман Линьчиковый Мститель", "Лепман Легенда Снюса",
    "Лепман Книга-Снюс", "Лепман Мастер Бутылочного Дождя", "Лепман Король Продристи", "Лепман Снюсо-Рокер",
    "Лепман Мокрый Линьчик", "Лепман Железный Лежун", "Лепман Преворкаутный Шаман", "Лепман Снюсо-Босс",
    "Лепман Книга-Гроза", "Лепман Жёлтый Призыватель", "Лепман Линьчиковый Принц", "Лепман Гроза Люкса",
    "Лепман Марафонщик Линьчика", "Лепман Папа Продристи", "Лепман Легенда Марафона", "Лепман Железный Снюс-Маг",
    "Лепман Король Оконных Дождей", "Лепман Мастер Потоков", "Лепман Балду-Каратель", "Лепман Снюсный Философ",
    "Лепман Преворкаутный Барон", "Лепман Линьчиковый Разрушитель", "Лепман Гроза Сантехники", "Лепман Жёлтый Маг",
    "Лепман Властелин Продристь", "Лепман Марафон Люксов", "Лепман Железный Балабол", "Лепман Снюсный Бродяга",
    "Лепман Преворкаутный Гладиатор", "Лепман Линьчиковый Певец", "Лепман Мастер Жёлтого Потока", "Лепман Книга-Воин",
    "Лепман Снюсо-Легенда", "Лепман Железный Поточник", "Лепман Гроза 110", "Лепман Марафон Мочи",
    "Лепман Властелин Линьчиковых Ночей", "Лепман Мастер Продристь", "Лепман Снюсный Принц", "Лепман Балду-Ломатель",
    "Лепман Железный Книгач", "Лепман Линьчиковый Шутник", "Лепман Преворкаутный Лев", "Лепман Жёлтый Джедай",
    "Лепман Книга-Гладиатор", "Лепман Снюсо-Герой", "Лепман Мастер Люксов", "Лепман Гроза Линьчика",
    "Лепман Железный Дождевик", "Лепман Преворкаутный Сокол", "Лепман Линьчиковый Левиафан", "Лепман Снюсный Рыцарь",
    "Лепман Легенда Книг", "Лепман Железный Мочевик", "Лепман Преворкаутный Чародей", "Лепман Марафонский Жрец",
    "Лепман Балду-Разрушитель", "Лепман Линьчиковый Орёл", "Лепман Жёлтый Фараон", "Лепман Снюсный Гуру",
    "Лепман Книга-Царь", "Лепман Преворкаутный Волк", "Лепман Железный Шаман", "Лепман Гроза Потоков",
    "Лепман Марафон Линьчика", "Лепман Линьчиковый Шаман", "Лепман Снюсо-Мастер", "Лепман Книга-Властелин",
    "Лепман Жёлтый Гладиатор", "Лепман Преворкаутный Легенд", "Лепман Железный Линьчикер", "Лепман Балду-Монарх",
    "Лепман Линьчиковый Властелин", "Лепман Снюсный Лев", "Лепман Марафонный Джин", "Лепман Жёлтый Босс",
    "Лепман Преворкаутный Папа", "Лепман Книга-Балабол", "Лепман Железный Люкс", "Лепман Снюсо-Бог",
    "Лепман Гроза Марафона", "Лепман Линьчиковый Папа", "Лепман Марафонщик Люксов", "Лепман Жёлтый Гроза",
    "Лепман Балду-Легенда", "Лепман Преворкаутный Орёл", "Лепман Книга-Поток", "Лепман Железный Марафонец",
    "Лепман Снюсо-Властелин", "Лепман Линьчиковый Волк", "Лепман Жёлтый Шаман", "Лепман Балду-Магистр",
    "Лепман Преворкаутный Гроза", "Лепман Книга-Дождевик", "Лепман Железный Поток", "Лепман Снюсо-Орёл",
    "Лепман Линьчиковый Барон", "Лепман Марафонский Волк", "Лепман Жёлтый Легенд", "Лепман Балду-Папа",
    "Лепман Преворкаутный Мастер", "Лепман Книга-Орёл", "Лепман Железный Властелин", "Лепман Снюсо-Джедай",
    "Лепман Линьчиковый Джин", "Лепман Марафонский Лев", "Лепман Жёлтый Призрак", "Лепман Балду-Герой",
    "Лепман Преворкаутный Линьчикер", "Лепман Книга-Гроза", "Лепман Железный Лев", "Лепман Снюсо-Фараон",
    "Лепман Линьчиковый Бог", "Лепман Марафонский Линьчик", "Лепман Жёлтый Книгач", "Лепман Балду-Мочевик",
    "Лепман Преворкаутный Поток", "Лепман Книга-Марафонец", "Лепман Сип-мастер", "Лепман Великий Сипун",
    "Лепман Сип-Барон", "Лепман Легенда Сипа", "Лепман Король Сипа", "Лепман Сипун Гладиатор",
    "Лепман Сип-Гроза", "Лепман Сипун Шаман", "Лепман Сипный Волк", "Лепман Марафон Сипа",
    "Лепман Трап-Властелин", "Лепман Ойкуменный Гашист", "Лепман Пуджевый Каратель", "Лепман Бушизмомант", "Лепман Шаман Трапчиков",
    "Лепман Гашишный Архонт", "Лепман Превеликий Трапчик", "Лепман Ойкуменный Барон", "Лепман Пудж-Магистр", "Лепман Бушистый Гладиатор",
    "Лепман Король Ойкумены", "Лепман Трапчик Люксовый", "Лепман Гашист Потоков", "Лепман Папа Пуджей", "Лепман Марафон Трапчиков",
    "Лепман Ойкуменный Лежун", "Лепман Гашик-Царь", "Лепман Пуджевый Фараон", "Лепман Бушизмомаг", "Лепман Железный Трапчик",
    "Лепман Гроза Ойкумены", "Лепман Гашист Люкса", "Лепман Пуджевый Орёл", "Лепман Трапчиконосец", "Лепман Бушизмолюб",
    "Лепман Ойкуменный Волк", "Лепман Гашик-Поточник", "Лепман Пуджевый Шаман", "Лепман Верховный Трапчик", "Лепман Бушистоносец",
    "Лепман Книга-Ойкумена", "Лепман Гашист-Мастер", "Лепман Пуджевый Барон", "Лепман Железный Бушист", "Лепман Снюсо-Трапчик",
    "Лепман Марафон Ойкумены", "Лепман Гашик-Босс", "Лепман Пуджевый Джедай", "Лепман Бушизмочародей", "Лепман Трапчик-Папа",
    "Лепман Легенда Ойкумены", "Лепман Гашист", "Лепман Преворкаут-Трапчик", "Лепман Бушизмомастер",
    "Лепман Ойкуменный Джин", "Лепман Гашик-Герой", "Лепман Пуджевый Легенд", "Лепман Трапчик Гроза", "Лепман Железный Гашист",
    "Лепман Гроза Пуджей", "Лепман Бушизмочкоед", "Лепман Ойкуменный Философ", "Лепман Трапчик-Вонючка", "Лепман Гашист-Книгач",
    "Лепман Пуджевый Разрушитель", "Лепман Бушизмогуру", "Лепман Книга-Трапчик", "Лепман Ойкуменный Призрак", "Лепман Гашик-Шаман",
    "Лепман Пуджевый Маг", "Лепман Трапчик-Сокол", "Лепман Бушизмоджедай", "Лепман Железный Ойкумен",
    "Лепман Марафон Гашика", "Лепман Пуджевый Линьчикарь", "Лепман Трапчик-Левиафан", "Лепман Ойкуменный Каратель", "Лепман Бушизмопевец",
    "Лепман Гашист-Книга", "Лепман Пуджевый Царь", "Лепман Трапчик-Магистр", "Лепман Железный Бушонок", "Лепман Ойкуменный Орёл",
    "Лепман Гашик-Балабол", "Лепман Пуджевый Сипарь", "Лепман Трапчик-Властелин", "Лепман Бушизмопоток", "Лепман Книга-Гашист",
    "Лепман Ойкуменный Мочевик", "Лепман Пуджевый Гроза", "Лепман Трапчик-Бог", "Лепман Железный Ойкуменист", "Лепман Гашист-Легенда",
    "Лепман Пуджевый Принц", "Лепман Бушизмопад", "Лепман Ойкуменный Лев", "Лепман Трапчик-Гладиатор", "Лепман Гашик-Рыцарь",
    "Лепман Пуджевый Джин", "Лепман Бушизмолорд", "Лепман Железный Трапчиконосец", "Лепман Ойкуменный Волшебник", "Лепман Гашист-Пророк",
    "Лепман Пуджевый Повелитель", "Лепман Трапчик-Книга", "Лепман Бушизмодемон", "Лепман Ойкуменный Поток", "Лепман Гашист-Марафонец"

]

STATE_FILE = "state.json"


# ==== ХРАНИЛКА ====
def load_state():
    try:
        with open(STATE_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    except FileNotFoundError:
        return {}

def save_state(state):
    with open(STATE_FILE, "w", encoding="utf-8") as f:
        json.dump(state, f, ensure_ascii=False, indent=2)


# ==== УТИЛИТЫ ====
def nickname_core(n: str) -> str:
    s = n
    if s.lower().startswith("лепман"):
        s = s[len("Лепман"):].strip(" —-")
    return s.strip()

def pick_for_history(history: list[str]) -> str:
    pool = [n for n in NICKNAMES if n not in history]
    if not pool:
        history.clear()
        pool = NICKNAMES[:]
    choice = random.choice(pool)
    history.append(choice)
    if len(history) > 7:
        history.pop(0)
    return choice

def pick_name_html(chat_id: int) -> str:
    """Для /lep и кнопки: «Лепман — <i>…</i>» с учётом истории чата"""
    state = load_state()
    entry = state.get(str(chat_id)) or {"history": []}
    nick = pick_for_history(entry["history"])
    state[str(chat_id)] = entry
    save_state(state)
    core = nickname_core(nick)
    return f"<b>Лепман</b> — <i>{html.escape(core)}</i>"

def mention_text(user) -> str:
    """@username если он есть, иначе просто имя (без @)."""
    return f"@{user.username}" if (user and user.username) else (user.first_name if user else "друг")


# ==== ХЕНДЛЕРЫ ====
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = ReplyKeyboardMarkup([[BTN_GEN]], resize_keyboard=True)
    await update.effective_message.reply_text("жми кнопку ниже ↓", reply_markup=kb)

async def lep_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    html_text = pick_name_html(update.effective_chat.id)
    await context.bot.send_message(
        chat_id=update.effective_chat.id,
        text=html_text,
        parse_mode="HTML",
    )

async def on_button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if (update.effective_message.text or "").strip() == BTN_GEN:
        html_text = pick_name_html(update.effective_chat.id)
        await update.effective_message.reply_html(html_text)

async def set_daily(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    1) Запоминает пользователя как цель daily в этом чате
    2) СРАЗУ выдает погоняло
    """
    chat_id = str(update.effective_chat.id)
    user = update.effective_user

    state = load_state()
    entry = state.get(chat_id) or {"history": []}
    entry["target"] = {"id": user.id, "username": user.username, "name": user.first_name}
    # сразу подберём ник с учётом истории
    nick_full = pick_for_history(entry["history"])
    state[chat_id] = entry
    save_state(state)

    core = nickname_core(nick_full)
    who = mention_text(user)
    # HTML + экранирование безопасны
    text = f"{html.escape(who)} — ты сегодня <b>{html.escape(core)}</b> 🎩\n" \
           f"Следующее погоняло придёт в 12:00 по МСК"

    await context.bot.send_message(
        chat_id=int(chat_id),
        text=text,
        parse_mode="HTML",
    )

async def stop_daily(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = str(update.effective_chat.id)
    state = load_state()
    if chat_id in state and ("target" in state[chat_id]):
        del state[chat_id]["target"]
        save_state(state)
        await update.effective_message.reply_text("Ежедневная выдача в этом чате отключена.")
    else:
        await update.effective_message.reply_text("В этом чате ежедневная выдача и так выключена.")

async def daily_job(context: ContextTypes.DEFAULT_TYPE):
    """Каждый день в 12:00 МСК: «@username — *погоняло* 🎩»"""
    state = load_state()
    changed = False
    for chat_id, entry in state.items():
        target = entry.get("target")
        if not target:
            continue

        # Подбираем новый ник без повторов последних 7
        nick_full = pick_for_history(entry.setdefault("history", []))
        core = nickname_core(nick_full)

        # используем @username если есть, иначе имя
        username = target.get("username")
        name = target.get("name") or "друг"
        who = f"@{username}" if username else name

        try:
            await context.bot.send_message(
                chat_id=int(chat_id),
                text=f"{html.escape(who)} — <b>{html.escape(core)}</b> 🎩",
                parse_mode="HTML",
            )
        except Exception as e:
            print(f"daily send failed for {chat_id}: {e}")
        changed = True

    if changed:
        save_state(state)


# ==== MAIN ====
def main():
    app = ApplicationBuilder().token(TOKEN).build()

    # ежедневная задача в 12:00 по МСК
    msk = pytz.timezone("Europe/Moscow")
    app.job_queue.run_daily(daily_job, time(hour=12, minute=0, tzinfo=msk))

    # команды/хендлеры
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("lep", lep_cmd))
    app.add_handler(CommandHandler("setdaily", set_daily))
    app.add_handler(CommandHandler("stopdaily", stop_daily))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, on_button))

    app.run_polling()

if __name__ == "__main__":
    main()
